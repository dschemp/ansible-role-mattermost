---
- name: "Setup systemd service."
  ansible.builtin.template:
    src: "mattermost.service.j2"
    dest: "/etc/systemd/system/{{ mattermost_service_name }}.service"
    owner: "root"
    group: "root"
    mode: "0644"

- name: "Flush handlers."
  ansible.builtin.meta: "flush_handlers"

- name: "Start and enable service."
  ansible.builtin.systemd_service:
    name: "{{ mattermost_service_name }}"
    daemon_reload: true
    enabled: "{{ mattermost_service_enabled }}"
    state: "{{ mattermost_service_state }}"

- name: "Wait for service to be up."
  when: "mattermost_service_state == 'started'"
  vars:
    # TODO: add _host part
    _port: "{{ (mattermost_webserver_listen_address | split(':'))[-1] }}"
  ansible.builtin.uri:
    url: "http://localhost:{{ _port }}/api/v4/system/ping"
  register: "_result"
  retries: 12 # 60s
  delay: 5
  until: "_result.status == 200"
